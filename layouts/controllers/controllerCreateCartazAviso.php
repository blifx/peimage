<?php
if(!empty($_POST)){

 /*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*---Variáveis vindas via post ou get------------------------------------------------------------------------------------------------------------------------*/
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
$texto1 = $_POST['texto1'];
$texto2 = $_POST['texto2'];
$texto3 = $_POST['texto3'];
$fonte = $_POST['font'];
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/   

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*---Variáveis que recebem diretórios ou arquivos------------------------------------------------------------------------------------------------------------*/
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $dirCompanie = '../companies/'.$companie.'/';
    $imgTheme = imagecreatefrompng('../images/fundo_branco_paisagem.png');
    $imgLogo = imagecreatefrompng($dirCompanie.'logo_branco.png');    
    /*Carrega fontes*/
    if($fonte == 'peimage'){
        $font = __DIR__.'/../../fonts/helveticaregular.otf';
        $fontBold =__DIR__.'/../../fonts/helveticaeb.otf';  

    }else{
        /*Carrega fontes*/
        $font = __DIR__.'/../../fonts/calibri.ttf';
        $fontBold = __DIR__.'/../../fonts/calibrib.ttf'; 
    }
/*----------------------------------------------------------------------------------------------------------------------------------------------------*/
/*---Gera o nome do arquivo----------------------------------------------------------------------------------------------------------------------------------*/
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/

$new_name = uniqid(rand(), true); 

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*---Criação de todos os objetos que serão inseridos na imagem final(imgTheme)-------------------------------------------------------------------------------*/
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $imgCabecalho = imagecreate(841,150);
    $imgTraco = imagecreate(20,100);
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*---Cores utilizadas no layoute-----------------------------------------------------------------------------------------------------------------------------*/
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
    $colorEmpresa = explode(',', $colorEmpresa);  //cor tema da empresa
    $cor_texto = explode(',', $cor_texto); //cor do texto da empresa
    imagecolorallocate($imgCabecalho,  $colorEmpresa[0], $colorEmpresa[1], $colorEmpresa[2]);
    imagecolorallocate($imgTraco,  $cor_texto[0], $cor_texto[1], $cor_texto[2]);
    /*Cores usadas na imagem do produto e tema*/
    $white = imagecolorallocate($imgTheme, 255, 255, 255);
    $black = imagecolorallocate($imgTheme, 0, 0, 0);
    $colorText_empresa = imagecolorallocate($imgTheme,  $cor_texto[0], $cor_texto[1], $cor_texto[2]);
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
    
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*---Lógica de Redimencionamento do logo------------- -------------------------------------------------------------------------------------------------------*/
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
list($width_logo, $height_logo) = getimagesize($dirCompanie.'logo_branco.png');
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*---Lógica de Centralização e ajuste de posição dos objetos do layout------------- -------------------------------------------------------------------------*/
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/    
$centerHorizontalCabecalho=centerText(841, 70, $font, 'Aviso');
$centerTexto1=centerText(841, 55, $font, $texto1);
$centerTexto2=centerText(841, 55, $font, $texto2);
$centerTexto3=centerText(841, 55, $font, $texto3);


//$centerHorizontalCabecalho=centerText(841, 100, $font, 'Aviso');
$centerVerticalLogo=centerImage(150,$height_logo/1.2);
$centerHorizontalLogo=centerImage(225,$width_logo/1.2);
$centerVerticalTraco=centerImage(150,112.5);
$centerVerticalCabecalho = imagettfbbox ( 70, 0, $font, 'Aviso' );
$centerVerticalCabecalho=centerImage(150,$centerVerticalCabecalho[5]);
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*---Insersão dos objetos na imagem final(imgTheme)------------- --------------------------------------------------------------------------------------------*/
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
imagecopymerge($imgTheme, $imgCabecalho, 0, 0, 0, 0, 841, 150, 100); 
imagecopymerge($imgTheme, $imgTraco, 225, $centerVerticalTraco, 0, 0, 13, 110, 100); 
imagecopyresampled($imgTheme, $imgLogo, $centerHorizontalLogo, $centerVerticalLogo, 0, 0, $width_logo/1.2, $height_logo/1.2, $width_logo, $height_logo);
imagettftext($imgTheme, 70, 0, $centerHorizontalCabecalho+117, $centerVerticalCabecalho, $colorText_empresa, $font, 'Aviso');

    if(!empty($texto1) && empty($texto2) && empty($texto3)){
        imagettftext($imgTheme, 55, 0, $centerTexto1, 380, $black, $font, $texto1);
    }else 
    if(!empty($texto1) && !empty($texto2) && empty($texto3)){
        imagettftext($imgTheme, 55, 0, $centerTexto1, 310, $black, $font, $texto1);
        imagettftext($imgTheme, 55, 0, $centerTexto2, 410, $black, $font, $texto2);

    }else
    if(!empty($texto1) && !empty($texto3) && empty($texto2)){

        imagettftext($imgTheme, 55, 0, $centerTexto1, 310, $black, $font, $texto1);
        imagettftext($imgTheme, 55, 0, $centerTexto3, 410, $black, $font, $texto3);

    }else
    if(!empty($texto1) && !empty($texto3) && !empty($texto3)){
        imagettftext($imgTheme, 55, 0, $centerTexto1, 290, $black, $font, $texto1);
        imagettftext($imgTheme, 55, 0, $centerTexto2, 390, $black, $font, $texto2);
        imagettftext($imgTheme, 55, 0, $centerTexto3, 490, $black, $font, $texto3);

    }
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/
/*---Salva imagem final e redireciona para pagina de download------------- ----------------------------------------------------------------------------------*/
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/ 
    /**Cria a imagem final*/
    $finalImage = $dirCompanie.'downloads/'.$new_name.'.png';
    imagepng($imgTheme, $finalImage, 0);
    header('Location: ../src/actionDownloads.php?download='.$new_name.'&estilo=paperAviso&usuario='.$idusuarios.'&idlayout='.$idlayout);
    imagepng($imgTheme);

    /**Limpa a memoria*/
    imagedestroy($imgTheme);
    imagedestroy($imgProduct);
    
/*-----------------------------------------------------------------------------------------------------------------------------------------------------------*/    
}
?>
